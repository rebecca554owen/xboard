# 自定义流量重置时间插件

## 概述

自定义流量重置时间插件，通过套餐标签配置重置周期和到期时间，支持异步于系统默认的重置逻辑。插件会自动为用户推算 `next_reset_at` 和 `expired_at`，确保订阅页与后台显示一致的下次流量重置时间和到期时间。

## 核心概念

- **`interval_days`**: 月付基础天数，作为计算的基础单位
- **实际到期天数**: `interval_days` × 订单周期乘数
- **周期映射**: 与系统 OrderService 保持一致

## 触发事件

插件在以下事件时触发重置时间和到期时间计算：

- 订单开通后（包含周期信息）
- 流量重置后
- 生成订阅响应时

## 触发时机

- 定时检查套餐标签变更和重置时间错误（默认每5分钟）
- 如有变更则重新计算相关用户

## 标签支持

### 重置周期标签
- **标签格式**: `interval_days:90`
- **说明**: 设置基础周期天数（相当于月付周期）

### 到期时间标签（可选）
- **标签格式**: `expired_days:90`
- **说明**: 直接指定到期天数，覆盖默认计算逻辑

## 周期映射

插件与系统 OrderService 的周期映射保持一致：

- **月付**: ×1
- **季付**: ×3
- **半年付**: ×6
- **年付**: ×12
- **两年付**: ×24
- **三年付**: ×36

## 计算逻辑

### 重置时间计算
- **优先基于上次重置时间**: 保持固定周期连续性
- **如果没有重置记录**: 基于当前时间计算
- **重置间隔不翻倍**: 确保每次重置间隔均为指定的天数
- **到期时间限制**: 重置时间不会超过用户到期时间

### 到期时间计算
- **基础逻辑**: 实际到期天数 = `interval_days` × 订单周期乘数
- **覆盖逻辑**: 如果设置了 `expired_days`，直接使用指定天数

## 使用示例

### 场景1：7天基础周期
```
标签：interval_days:7
- 月付：7天（7×1）
- 季付：21天（7×3）
- 半年付：42天（7×6）
```

### 场景2：30天基础周期
```
标签：interval_days:30
- 月付：30天（30×1）
- 季付：90天（30×3）
- 半年付：180天（30×6）
```

### 场景3：90天基础周期
```
标签：interval_days:90
- 月付：90天（90×1）
- 季付：270天（90×3）
- 半年付：540天（90×6）
```

### 场景4：自定义到期日
```
标签：interval_days:15,expired_days:45
- 重置周期：15天
- 到期时间：45天（覆盖默认计算）
```

## 配置字段

- **启用插件**: 关闭后不会再覆盖系统默认的流量重置逻辑
- **默认重置间隔（天）**: 套餐未匹配标签时使用的间隔；0 代表跳过自动重置（默认值 30 天）
- **批处理用户数量**: 套餐标签变更时每批处理的用户数量（默认值 100）
- **启用到期日计算**: 根据套餐标签中的重置周期计算用户到期时间

## 错误修复机制

插件包含自动修复机制，定时检查以下问题（间隔可配置）：

- **套餐标签变更**：检测套餐标签变化并重新计算相关用户
- **自定义周期用户被 TrafficReset 插件重置后**：`next_reset_at` 可能没有被正确更新
- **下次重置时间与预期周期不符**：时间差超过1天时自动修复
- **重置时间为空**：自动重新计算

## 注意事项

- 插件会写入用户表的 `next_reset_at` 和 `expired_at` 字段，请确认业务允许覆盖该字段
- 若要立即停用自动重置，只需关闭插件或将默认间隔设置为 0
- 标签优先于默认值；命中标签后即停止继续匹配
- 到期日计算功能可独立开关，不影响重置时间计算
- 错误修复机制确保自定义周期用户的 next_reset_at 始终正确
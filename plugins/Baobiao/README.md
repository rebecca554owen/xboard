# 报表插件（Baobiao）

## 插件简介

该插件提供完整的运营数据监控和报告功能，支持自动报告和手动查询。通过 Telegram 机器人命令，管理员可以随时获取运营数据、用户流量排行和服务器流量排行。

## 核心功能

### 1. 自动报告
- 每天指定时间自动发送昨日运营数据报告
- 包含用户统计、订单统计、支付渠道等核心指标
- 仅在存在收入数据时发送，避免空报表

### 2. Telegram 命令

#### `/day [天数]` - 运营报告
查询指定天数的运营数据统计

**参数说明：**
- `天数`：查询天数，默认1天，最大365天

**报告内容：**
- 用户统计：新增、到期、续费、升级用户及续费率
- 订单统计：新购、续费、升级订单数量和金额
- 支付渠道：各支付方式的交易笔数和金额
- 总收入汇总

#### `/top [天数] [数量]` - 用户流量排行
查询指定天数的用户流量消耗排行

**参数说明：**
- `天数`：查询天数，默认0天（当天），最大365天
- `数量`：显示用户数量，默认10，最大50

**排行内容：**
- 用户邮箱
- 流量消耗量（自动转换为 B/KB/MB/GB/TB）

#### `/tops [天数] [数量]` - 服务器流量排行
查询指定天数的服务器流量排行

**参数说明：**
- `天数`：查询天数，默认0天（当天），最大365天
- `数量`：显示服务器数量，默认10，最大50

**排行内容：**
- 服务器名称
- 服务器类型
- 流量消耗量（自动转换为 B/KB/MB/GB/TB）

## 配置项说明

| 配置项 | 说明 | 默认值 | 类型 |
| --- | --- | --- | --- |
| `enable_auto_report` | 启用自动报告功能 | `true` | boolean |
| `report_time` | 自动发送报告的时间（格式：HH:MM） | `09:00` | string |
| `top_limit` | 排行榜显示的用户/服务器数量 | `10` | integer |

## 技术架构

### 数据查询
- **运营数据**：基于 `Order`、`User`、`Payment` 模型直接查询
- **用户排行**：使用 `StatisticalService::getRanking('user_consumption_rank')` 查询用户流量数据
- **服务器排行**：使用 `StatisticalService::getRanking('server_traffic_rank')` 查询服务器流量数据

### 权限控制
- 仅管理员和员工可使用所有命令
- 普通用户无法执行任何命令
- 仅支持私聊消息

### 性能优化
- 限制最大查询天数（365天）
- 限制排行榜显示数量（最大50条）
- 使用系统已有的统计服务，避免重复查询

## 使用示例

```
# 查询最近7天运营数据
/day 7

# 显示前5名用户流量排行
/top 0 5

# 查询昨日用户流量排行前10名
/top 1 10

# 查询最近7天用户流量排行前5名
/top 7 5

# 显示前10名服务器流量排行
/tops 0 10

# 查询昨日服务器流量排行前5名
/tops 1 5

# 查询最近7天服务器流量排行前10名
/tops 7 10

# 查询昨日运营数据（默认）
/day
```

## 运营提示

1. **自动报告时间**：建议设置在业务低峰期，如早上9:00
2. **查询范围**：大范围查询（如90天以上）可能需要较长时间处理
3. **数据准确性**：报告基于数据库实时数据，反映实际运营状况
4. **权限管理**：确保只有授权人员可以访问敏感运营数据

## 技术特性

- **权限安全**：严格的权限控制和私聊限制
- **参数验证**：所有输入参数都经过范围验证
- **错误处理**：友好的错误提示和异常处理
- **数据格式化**：流量数据自动转换，金额格式化显示
- **性能优化**：合理的查询限制和缓存利用
# 流量耗尽自动重置插件（TrafficReset）

## 插件简介

当用户在计费周期内耗尽所有流量时，插件会根据套餐的重置策略缩短有效期，并调用系统流量重置服务，帮助运营侧减少人工干预。

## 核心流程

1. 定时任务按配置频率扫描满足条件的用户（已绑定套餐、未封禁、仍在有效期内且 `(u + d) >= transfer_enable * 0.99`）。
2. 命中用户后核对套餐的重置方式（按月结日、每月一号或自定义周期）。
3. 根据不同方式推算新的 `expired_at`，写入用户表，并调用 `TrafficResetService` 执行实际的流量清零与日志记录。

## 流量重置策略

- **按月结日提前重置**：以当前日期为基准，将原本的结日向前移动，保持时分秒与当前时间一致，然后触发流量重置。
- **每月一号提前重置**：直接将到期时间回拨一个月，并在完成后立即重置流量。
- **自定义周期重置**：对于使用自定义周期的套餐，从原到期时间中扣除一个周期作为提前重置的代价。

## 自定义周期支持

插件支持通过套餐标签配置自定义重置周期：

- **标签格式**：`interval_days:7`
- **说明**：设置基础周期天数，例如7天、15天、30天等
- **重置逻辑**：从原到期时间中扣除一个周期天数作为提前重置的代价

## 配置项说明

- **启用自动重置**：关闭后定时任务仍会运行，但不会执行流量重置逻辑。
- **定时任务频率**：可选择每分钟、每小时或每天 00:00 执行一次扫描。
- **批处理用户数量**：控制每批次最多处理的用户数量，建议结合服务器性能调节。
- **按月结日重置**：决定"按月结日"类型套餐在流量耗尽时是否允许提前重置。
- **每月一号重置**：决定"每月一号"类型套餐在流量耗尽时是否允许提前重置。
- **自定义周期重置**：决定使用自定义周期的套餐在流量耗尽时是否允许提前重置。

## 运营提示

- 插件会在用户层面更新 `expired_at`，请确认手动修改有效期不会与自动重置冲突。
- 对于其他重置策略（按年、禁止重置等），插件不会干预，仍交由系统默认逻辑处理。
- 自定义周期用户需要满足剩余时间大于周期天数才能触发重置，避免频繁重置。
- 自定义周期用户重置后会更新 `next_reset_at` 字段，确保下次重置时间正确。

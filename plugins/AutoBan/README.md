# 自动流量封禁插件

每日流量超出阈值自动封禁，定时解禁用户。

## 功能特性

- **自动流量监控**: 根据配置的扫描间隔实时监控用户流量
- **智能封禁**: 当用户当日流量超过设定阈值时自动封禁
- **安全解禁**: 每日定时解禁因流量超限被封禁的用户
- **防误封禁**: 只解禁自动封禁的用户，不影响其他原因被封禁的用户
- **分布式锁**: 避免重复执行任务
- **事务保护**: 数据库操作支持事务回滚

## 配置选项

### 启用自动封禁
- **类型**: 布尔值
- **默认**: `true`
- **描述**: 根据今日流量统计封禁超出阈值的用户

### 用户每日流量上限 (GB)
- **类型**: 数字
- **默认**: `300`
- **描述**: 用户今日流量超过该值将被封禁

### 扫描间隔 (分钟)
- **类型**: 数字
- **默认**: `1`
- **描述**: 自动封禁扫描的时间间隔，大于0的整数

### 启用每日解禁
- **类型**: 布尔值
- **默认**: `true`
- **描述**: 每天自动解禁所有被封禁用户

### 解禁执行时间
- **类型**: 文本
- **默认**: `00:00`
- **描述**: 自动解禁任务的执行时间 (HH:MM)

## 工作原理

### 封禁流程
1. 根据配置的扫描间隔定期执行流量检查
2. 获取当日所有用户的流量统计数据
3. 验证用户状态（使用 UserService::isAvailable()）
4. 对流量超过阈值的用户进行封禁
5. 在用户 `remarks` 字段添加"自动流量封禁"标识
6. 记录详细的封禁日志

### 解禁流程
1. 每日在指定时间执行解禁任务
2. 只解禁带有"自动流量封禁"标识的用户
3. 移除封禁标识，恢复用户状态
4. 记录解禁日志

## 技术实现

### 分布式锁
- 使用 Redis 缓存实现分布式锁
- 避免多个任务实例同时执行
- 锁有效期为 5 分钟

### 数据库事务
- 所有数据库操作都支持事务
- 确保数据一致性
- 支持回滚机制

### 用户状态验证
- 使用 `UserService::isAvailable()` 方法
- 只对可用用户进行流量检查
- 避免对已封禁或无效用户重复操作

### 流量统计方式
- 从 Redis 缓存读取实时流量数据
- 基于 `StatisticalService` 获取当日用户流量
- 统计格式：`{rate}_{user_id}_{type}` (u=上传, d=下载)

## 日志记录

插件会记录详细的执行日志：

- 任务执行状态
- 封禁用户详情（用户ID、邮箱、流量使用情况）
- 解禁操作结果
- 错误和异常信息
- 执行时间统计

## 注意事项

1. **解禁安全性**: 插件只会解禁带有"自动流量封禁"标识的用户，不会影响其他原因被封禁的用户
2. **性能考虑**: 扫描间隔建议根据实际用户量调整，避免过于频繁的数据库查询
3. **流量统计**: 依赖系统的流量统计服务，确保流量数据准确
4. **用户状态**: 插件会验证用户状态，只对可用用户进行操作

## 版本历史

- **v1.0.0**: 初始版本，支持自动流量封禁和定时解禁
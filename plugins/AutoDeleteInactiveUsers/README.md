# 自动删除无效用户插件

## 插件简介

定时清理无效用户和过期用户，支持试运行模式和安全保护。

## 配置项说明

| 配置项 | 说明 | 默认值 | 类型 |
| --- | --- | --- | --- |
| `enable_auto_delete` | 启用自动删除功能，关闭时为试运行模式 | `false` | boolean |
| `schedule_frequency` | 定时任务频率（minutely/hourly/daily） | `minutely` | select |
| `delete_days` | 注册超过该天数仍未激活的用户才会被清理 | `7` | number |
| `delete_expired_users_after_days` | 删除过期超过指定天数的用户 | `0` | number |
| `batch_size` | 每批次最多处理的用户数量 | `1024` | number |

**定时任务频率说明：**
- `minutely`：每分钟执行一次
- `hourly`：每小时执行一次
- `daily`：每天00:00执行一次

**删除过期用户说明：**
- `0`：不删除过期用户（使用基础清理模式）
- `>0`：删除过期超过指定天数的用户

## 清理模式

### 基础模式（默认）
清理注册超过指定天数的无效用户：

**查询条件：**
- `is_admin = false` - 非管理员用户
- `last_login_at IS NULL` - 从未登录
- `plan_id IS NULL` - 无套餐
- `transfer_enable = 0` - 无流量
- `expired_at = 0` - 未设置到期时间
- `balance = 0` - 余额为0
- `commission_balance = 0` - 佣金余额为0
- 无邀请关系 - 未邀请过其他用户
- `created_at < (当前时间 - 注册天数阈值)` - 注册超过指定天数

### 过期用户模式
清理过期超过指定天数的用户：

**查询条件：**
- `is_admin = false` - 非管理员用户
- `expired_at > 0` - 已设置过期时间
- `expired_at < (当前时间 - 过期天数阈值)` - 过期超过指定天数
- `balance = 0` - 余额为0
- `commission_balance = 0` - 佣金余额为0
- `created_at < (当前时间 - 注册天数阈值)` - 注册超过指定天数

## 使用建议

1. **首次启用**：建议先设置 `enable_auto_delete = false`（试运行模式），通过日志确认清理范围后再开启真实删除
2. **清理模式选择**：
   - 基础清理：适合清理纯被刷注册的用户
   - 过期用户清理：适合清理过期n天未续费的用户
3. **性能调节**：根据服务器性能调节"单次处理数量"，避免数据库压力过大
4. **监控日志**：定期审阅任务日志，了解清理效果并及时调整阈值
5. **安全保障**：插件保护管理员、有余额和有佣金的用户，两种清理模式均不会删除管理员

## 技术特性

- **并发安全**：使用缓存锁防止任务重复执行
- **事务保护**：每个用户删除操作都是原子性的
- **批量处理**：支持分批处理大量用户
- **错误恢复**：单个用户删除失败不影响其他用户
- **详细日志**：提供完整的执行过程记录
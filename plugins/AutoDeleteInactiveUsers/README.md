# 自动删除无效用户插件（AutoDeleteInactiveUsers）

## 插件简介

该插件用于清理长期未激活、无套餐与无流量额度的注册用户，减少无效账号占用资源并保持数据库整洁。支持试运行模式，便于在正式清理前评估影响。

## 工作流程

1. **定时任务触发**：按照设定的频率（每分钟/每小时/每天）触发扫描任务
2. **并发控制**：使用缓存锁（5分钟有效期）防止多个任务实例同时运行
3. **用户筛选条件**：系统筛选同时满足以下条件的用户：
   - 未绑定套餐（`plan_id` 为空）
   - 没有流量额度（`transfer_enable = 0`）
   - 未设置到期时间（`expired_at = 0`）
   - 从未登录（`last_login_at` 为空）
   - 非管理员账号（`is_admin = 0`）
   - 没有邀请其他用户（未出现在 `invite_user_id` 字段中）
   - 注册时间早于当前时间减去设定的天数阈值
4. **批量处理**：每次处理指定数量的用户（默认100个），避免数据库压力过大
5. **事务保护**：每个用户的删除操作在数据库事务中执行，确保数据一致性
6. **关联数据清理**：删除用户时同时清理其关联的订单、兑换码、统计数据和工单

## 配置项说明

| 配置项 | 说明 | 默认值 | 类型 |
| --- | --- | --- | --- |
| `enable_auto_delete` | 启用自动删除功能 | `false` | boolean |
| `delete_days` | 注册超过该天数仍未激活的用户才会被清理 | `7` | integer |
| `batch_size` | 每批次最多处理的用户数量 | `100` | integer |
| `schedule_frequency` | 扫描执行频率（minutely/hourly/daily） | `daily` | string |
| `dry_run` | 试运行模式，开启后仅记录日志不执行真实删除 | `true` | boolean |

## 日志输出

插件执行过程中会输出详细的日志信息：

- **任务状态**：检测到任务已在运行时跳过执行
- **试运行模式**：记录匹配的用户数量但不执行删除
- **实际删除**：记录每轮删除的用户数量和累计数量
- **错误处理**：删除失败时记录详细错误信息
- **用户详情**：删除用户时记录ID、邮箱和注册时间

## 使用建议

1. **首次启用**：建议先开启试运行模式，确认日志中的命中范围是否符合预期
2. **性能调节**：根据服务器性能调节"单次处理数量"，避免数据库压力过大
3. **监控日志**：定期审阅任务日志，了解清理效果并及时调整阈值
4. **安全保障**：插件不会删除仍在使用或已激活的用户，可放心启用
5. **事务保护**：每个用户的删除操作都在事务中执行，确保数据一致性

## 技术特性

- **并发安全**：使用缓存锁防止任务重复执行
- **事务保护**：每个用户删除操作都是原子性的
- **批量处理**：支持分批处理大量用户
- **错误恢复**：单个用户删除失败不影响其他用户
- **详细日志**：提供完整的执行过程记录